<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messaging System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #6366f1;
        }
        .success { border-left-color: #10b981; }
        .error { border-left-color: #ef4444; }
        .warning { border-left-color: #f59e0b; }
        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #4f46e5; }
        button:disabled { background: #6b7280; cursor: not-allowed; }
        input, textarea {
            background: #374151;
            color: white;
            border: 1px solid #4b5563;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            margin: 5px 0;
        }
        .log {
            background: #111;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .message {
            background: #374151;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #6366f1;
        }
    </style>
</head>
<body>
    <h1>üß™ Messaging System Test</h1>
    
    <div class="test-section">
        <h3>1. Authentication</h3>
        <button onclick="signInAsAlice()">Sign in as Alice</button>
        <button onclick="signInAsBob()">Sign in as Bob</button>
        <div id="auth-status">Not signed in</div>
    </div>

    <div class="test-section">
        <h3>2. Friends List</h3>
        <button onclick="getFriends()" id="friends-btn" disabled>Get Friends</button>
        <div id="friends-list"></div>
    </div>

    <div class="test-section">
        <h3>3. Create Conversation</h3>
        <button onclick="createConversation()" id="conv-btn" disabled>Create Direct Chat with Bob</button>
        <div id="conversation-status"></div>
    </div>

    <div class="test-section">
        <h3>4. Send Messages</h3>
        <textarea id="message-input" placeholder="Type your message..." rows="3"></textarea>
        <button onclick="sendMessage()" id="send-btn" disabled>Send Message</button>
        <div id="messages-list"></div>
    </div>

    <div class="test-section">
        <h3>5. Search Messages</h3>
        <input type="text" id="search-input" placeholder="Search messages...">
        <button onclick="searchMessages()" id="search-btn" disabled>Search</button>
        <div id="search-results"></div>
    </div>

    <div class="test-section">
        <h3>6. Export Conversation</h3>
        <button onclick="exportConversation()" id="export-btn" disabled>Export as JSON</button>
        <div id="export-status"></div>
    </div>

    <div class="test-section">
        <h3>Test Log</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        let currentToken = null;
        let currentUserId = null;
        let conversationId = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function signInAsAlice() {
            try {
                const response = await fetch('/api/auth/signin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'alice@example.com',
                        password: 'Password1!'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.data.token;
                    currentUserId = data.data.user.id;
                    document.getElementById('auth-status').innerHTML = `‚úÖ Signed in as ${data.data.user.name}`;
                    document.getElementById('friends-btn').disabled = false;
                    log('Successfully signed in as Alice', 'success');
                } else {
                    const error = await response.text();
                    document.getElementById('auth-status').innerHTML = `‚ùå Sign in failed: ${error}`;
                    log(`Sign in failed: ${error}`, 'error');
                }
            } catch (error) {
                log(`Sign in error: ${error.message}`, 'error');
            }
        }

        async function signInAsBob() {
            try {
                const response = await fetch('/api/auth/signin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'bob@example.com',
                        password: 'Password1!'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.data.token;
                    currentUserId = data.data.user.id;
                    document.getElementById('auth-status').innerHTML = `‚úÖ Signed in as ${data.data.user.name}`;
                    document.getElementById('friends-btn').disabled = false;
                    log('Successfully signed in as Bob', 'success');
                } else {
                    const error = await response.text();
                    document.getElementById('auth-status').innerHTML = `‚ùå Sign in failed: ${error}`;
                    log(`Sign in failed: ${error}`, 'error');
                }
            } catch (error) {
                log(`Sign in error: ${error.message}`, 'error');
            }
        }

        async function getFriends() {
            try {
                const response = await fetch('/api/friends', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const friendsList = data.data.friends.map(friend => 
                        `<div>${friend.name} (@${friend.username})</div>`
                    ).join('');
                    document.getElementById('friends-list').innerHTML = friendsList;
                    document.getElementById('conv-btn').disabled = false;
                    log(`Retrieved ${data.data.friends.length} friends`, 'success');
                } else {
                    log('Failed to get friends', 'error');
                }
            } catch (error) {
                log(`Get friends error: ${error.message}`, 'error');
            }
        }

        async function createConversation() {
            try {
                // Find Bob's ID (assuming we're Alice)
                const friendsResponse = await fetch('/api/friends', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!friendsResponse.ok) {
                    log('Failed to get friends for conversation', 'error');
                    return;
                }

                const friendsData = await friendsResponse.json();
                const bob = friendsData.data.friends.find(f => f.username === 'bob');
                
                if (!bob) {
                    log('Bob not found in friends list', 'error');
                    return;
                }

                const response = await fetch('/api/conversations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        type: 'DIRECT',
                        participantIds: [bob.id]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    conversationId = data.data.conversation.id;
                    document.getElementById('conversation-status').innerHTML = `‚úÖ Conversation created: ${conversationId}`;
                    document.getElementById('send-btn').disabled = false;
                    document.getElementById('search-btn').disabled = false;
                    document.getElementById('export-btn').disabled = false;
                    log('Conversation created successfully', 'success');
                } else {
                    const error = await response.text();
                    document.getElementById('conversation-status').innerHTML = `‚ùå Failed to create conversation: ${error}`;
                    log(`Create conversation failed: ${error}`, 'error');
                }
            } catch (error) {
                log(`Create conversation error: ${error.message}`, 'error');
            }
        }

        async function sendMessage() {
            const messageText = document.getElementById('message-input').value.trim();
            if (!messageText) return;

            try {
                const response = await fetch(`/api/conversations/${conversationId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        content: messageText,
                        type: 'TEXT'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message';
                    messageDiv.innerHTML = `<strong>You:</strong> ${messageText}`;
                    document.getElementById('messages-list').appendChild(messageDiv);
                    document.getElementById('message-input').value = '';
                    log(`Message sent: "${messageText}"`, 'success');
                } else {
                    const error = await response.text();
                    log(`Send message failed: ${error}`, 'error');
                }
            } catch (error) {
                log(`Send message error: ${error.message}`, 'error');
            }
        }

        async function searchMessages() {
            const searchQuery = document.getElementById('search-input').value.trim();
            if (!searchQuery) return;

            try {
                const response = await fetch(`/api/messages/search?q=${encodeURIComponent(searchQuery)}&conversationId=${conversationId}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const results = data.data.results.map(result => 
                        `<div class="message"><strong>${result.sender.name}:</strong> ${result.content}</div>`
                    ).join('');
                    document.getElementById('search-results').innerHTML = results || 'No results found';
                    log(`Search found ${data.data.results.length} results`, 'success');
                } else {
                    log('Search failed', 'error');
                }
            } catch (error) {
                log(`Search error: ${error.message}`, 'error');
            }
        }

        async function exportConversation() {
            try {
                const response = await fetch(`/api/conversations/${conversationId}/export?format=json`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `conversation-export-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    document.getElementById('export-status').innerHTML = '‚úÖ Export downloaded successfully';
                    log('Conversation exported successfully', 'success');
                } else {
                    log('Export failed', 'error');
                }
            } catch (error) {
                log(`Export error: ${error.message}`, 'error');
            }
        }

        // Allow Enter key to send message
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Allow Enter key to search
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchMessages();
            }
        });

        log('Messaging system test page loaded. Start by signing in as Alice.', 'info');
    </script>
</body>
</html>
