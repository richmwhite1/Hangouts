<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Messaging System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #333; border-radius: 8px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
        button { background: #6366f1; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #4f46e5; }
        input, textarea { background: #374151; color: white; border: 1px solid #4b5563; padding: 8px; border-radius: 4px; margin: 5px; }
        .conversation { background: #2d2d2d; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .message { background: #404040; padding: 8px; margin: 5px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Messaging System Test</h1>
        
        <div class="section">
            <h2>1. Authentication</h2>
            <button onclick="login()">Login as Alice</button>
            <button onclick="logout()">Logout</button>
            <div id="auth-status"></div>
        </div>

        <div class="section">
            <h2>2. Friends List</h2>
            <button onclick="fetchFriends()">Fetch Friends</button>
            <div id="friends-list"></div>
        </div>

        <div class="section">
            <h2>3. Conversations</h2>
            <button onclick="fetchConversations()">Fetch Conversations</button>
            <div id="conversations-list"></div>
        </div>

        <div class="section">
            <h2>4. Create Direct Message</h2>
            <select id="friend-select">
                <option value="">Select a friend</option>
            </select>
            <button onclick="createDirectMessage()">Create Direct Message</button>
            <div id="direct-message-result"></div>
        </div>

        <div class="section">
            <h2>5. Create Group Message</h2>
            <div>
                <label><input type="checkbox" value="cmg890tow0001jpqvwuv3nut1"> Bob Smith</label><br>
                <label><input type="checkbox" value="cmg890tp40009jpqvzsqir3bd"> Jack Wilson</label><br>
                <label><input type="checkbox" value="cmg890tp30008jpqv4dgolrby"> Ivy Chen</label><br>
            </div>
            <input type="text" id="group-name" placeholder="Group name" value="Test Group">
            <button onclick="createGroupMessage()">Create Group Message</button>
            <div id="group-message-result"></div>
        </div>

        <div class="section">
            <h2>6. Send Message</h2>
            <select id="conversation-select">
                <option value="">Select a conversation</option>
            </select>
            <textarea id="message-text" placeholder="Type your message" rows="3" cols="50"></textarea>
            <button onclick="sendMessage()">Send Message</button>
            <div id="send-message-result"></div>
        </div>

        <div class="section">
            <h2>7. View Messages</h2>
            <select id="view-conversation-select">
                <option value="">Select a conversation to view messages</option>
            </select>
            <button onclick="viewMessages()">View Messages</button>
            <div id="messages-list"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        let friends = [];
        let conversations = [];

        async function login() {
            try {
                const response = await fetch('/api/auth/signin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'alice@example.com',
                        password: 'Password1!'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    authToken = data.data.token;
                    document.getElementById('auth-status').innerHTML = 
                        `<div class="success">✅ Logged in as ${data.data.user.name}</div>`;
                } else {
                    document.getElementById('auth-status').innerHTML = 
                        `<div class="error">❌ Login failed: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('auth-status').innerHTML = 
                    `<div class="error">❌ Login error: ${error.message}</div>`;
            }
        }

        async function logout() {
            authToken = null;
            document.getElementById('auth-status').innerHTML = 
                `<div class="info">ℹ️ Logged out</div>`;
        }

        async function fetchFriends() {
            if (!authToken) {
                document.getElementById('friends-list').innerHTML = 
                    `<div class="error">❌ Please login first</div>`;
                return;
            }

            try {
                const response = await fetch('/api/friends', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                if (data.success) {
                    friends = data.data.friends;
                    let html = '<div class="success">✅ Friends loaded:</div><ul>';
                    friends.forEach(friend => {
                        html += `<li>${friend.name} (${friend.username})</li>`;
                    });
                    html += '</ul>';
                    
                    // Populate friend select
                    const friendSelect = document.getElementById('friend-select');
                    friendSelect.innerHTML = '<option value="">Select a friend</option>';
                    friends.forEach(friend => {
                        friendSelect.innerHTML += `<option value="${friend.id}">${friend.name}</option>`;
                    });
                    
                    document.getElementById('friends-list').innerHTML = html;
                } else {
                    document.getElementById('friends-list').innerHTML = 
                        `<div class="error">❌ Failed to fetch friends: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('friends-list').innerHTML = 
                    `<div class="error">❌ Error fetching friends: ${error.message}</div>`;
            }
        }

        async function fetchConversations() {
            if (!authToken) {
                document.getElementById('conversations-list').innerHTML = 
                    `<div class="error">❌ Please login first</div>`;
                return;
            }

            try {
                const response = await fetch('/api/conversations', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                if (data.success) {
                    conversations = data.data.conversations;
                    let html = '<div class="success">✅ Conversations loaded:</div>';
                    conversations.forEach(conv => {
                        html += `<div class="conversation">
                            <strong>${conv.name}</strong> (${conv.type})
                            <br>Participants: ${conv.participants.map(p => p.name).join(', ')}
                            <br>Last message: ${conv.lastMessage ? conv.lastMessage.content : 'No messages'}
                        </div>`;
                    });
                    
                    // Populate conversation selects
                    const convSelect = document.getElementById('conversation-select');
                    const viewConvSelect = document.getElementById('view-conversation-select');
                    convSelect.innerHTML = '<option value="">Select a conversation</option>';
                    viewConvSelect.innerHTML = '<option value="">Select a conversation to view messages</option>';
                    conversations.forEach(conv => {
                        convSelect.innerHTML += `<option value="${conv.id}">${conv.name}</option>`;
                        viewConvSelect.innerHTML += `<option value="${conv.id}">${conv.name}</option>`;
                    });
                    
                    document.getElementById('conversations-list').innerHTML = html;
                } else {
                    document.getElementById('conversations-list').innerHTML = 
                        `<div class="error">❌ Failed to fetch conversations: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('conversations-list').innerHTML = 
                    `<div class="error">❌ Error fetching conversations: ${error.message}</div>`;
            }
        }

        async function createDirectMessage() {
            const friendId = document.getElementById('friend-select').value;
            if (!friendId) {
                document.getElementById('direct-message-result').innerHTML = 
                    `<div class="error">❌ Please select a friend</div>`;
                return;
            }

            try {
                const response = await fetch('/api/conversations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        type: 'DIRECT',
                        participantIds: [friendId]
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('direct-message-result').innerHTML = 
                        `<div class="success">✅ Direct message created: ${data.data.conversation.name}</div>`;
                    fetchConversations(); // Refresh conversations
                } else {
                    document.getElementById('direct-message-result').innerHTML = 
                        `<div class="error">❌ Failed to create direct message: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('direct-message-result').innerHTML = 
                    `<div class="error">❌ Error creating direct message: ${error.message}</div>`;
            }
        }

        async function createGroupMessage() {
            const selectedFriends = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const groupName = document.getElementById('group-name').value;

            if (selectedFriends.length === 0) {
                document.getElementById('group-message-result').innerHTML = 
                    `<div class="error">❌ Please select at least one friend</div>`;
                return;
            }

            try {
                const response = await fetch('/api/conversations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        type: 'GROUP',
                        name: groupName,
                        participantIds: selectedFriends
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('group-message-result').innerHTML = 
                        `<div class="success">✅ Group message created: ${data.data.conversation.name}</div>`;
                    fetchConversations(); // Refresh conversations
                } else {
                    document.getElementById('group-message-result').innerHTML = 
                        `<div class="error">❌ Failed to create group message: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('group-message-result').innerHTML = 
                    `<div class="error">❌ Error creating group message: ${error.message}</div>`;
            }
        }

        async function sendMessage() {
            const conversationId = document.getElementById('conversation-select').value;
            const messageText = document.getElementById('message-text').value;

            if (!conversationId || !messageText) {
                document.getElementById('send-message-result').innerHTML = 
                    `<div class="error">❌ Please select a conversation and enter a message</div>`;
                return;
            }

            try {
                const response = await fetch(`/api/conversations/${conversationId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        content: messageText
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('send-message-result').innerHTML = 
                        `<div class="success">✅ Message sent: "${data.data.message.content}"</div>`;
                    document.getElementById('message-text').value = '';
                } else {
                    document.getElementById('send-message-result').innerHTML = 
                        `<div class="error">❌ Failed to send message: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('send-message-result').innerHTML = 
                    `<div class="error">❌ Error sending message: ${error.message}</div>`;
            }
        }

        async function viewMessages() {
            const conversationId = document.getElementById('view-conversation-select').value;

            if (!conversationId) {
                document.getElementById('messages-list').innerHTML = 
                    `<div class="error">❌ Please select a conversation</div>`;
                return;
            }

            try {
                const response = await fetch(`/api/conversations/${conversationId}/messages`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                if (data.success) {
                    let html = '<div class="success">✅ Messages loaded:</div>';
                    data.data.messages.forEach(msg => {
                        html += `<div class="message">
                            <strong>${msg.sender.name}:</strong> ${msg.content}
                            <br><small>${new Date(msg.createdAt).toLocaleString()}</small>
                        </div>`;
                    });
                    document.getElementById('messages-list').innerHTML = html;
                } else {
                    document.getElementById('messages-list').innerHTML = 
                        `<div class="error">❌ Failed to fetch messages: ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('messages-list').innerHTML = 
                    `<div class="error">❌ Error fetching messages: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
