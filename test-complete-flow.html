<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Hangout Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000;
            color: #fff;
        }
        .test-section {
            background: #333;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .info { background: #2d4a5a; }
        button {
            background: #792ADB;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #6a1fc7; }
        button:disabled { background: #555; cursor: not-allowed; }
        .hangout-card {
            background: #444;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
        }
        .hangout-image {
            width: 100%;
            max-width: 300px;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
            margin: 10px 0;
        }
        .participant-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .participant {
            background: #555;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        .vote-section {
            background: #444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .vote-option {
            background: #555;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .vote-button {
            background: #792ADB;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
        }
        .vote-button.voted {
            background: #4CAF50;
        }
        .chat-section {
            background: #444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        .message {
            background: #555;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .message-input {
            width: 100%;
            padding: 10px;
            background: #555;
            border: 1px solid #666;
            color: white;
            border-radius: 4px;
        }
        .photo-section {
            background: #444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .photo-item {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
        }
        .file-input {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Complete Hangout Flow Test</h1>
    
    <div class="test-section">
        <h2>1. Authentication Test</h2>
        <button onclick="testAuth()">Test Authentication</button>
        <div id="auth-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>2. Discover Hangouts Test</h2>
        <button onclick="testDiscover()">Load Discover Hangouts</button>
        <div id="discover-result" class="test-result"></div>
        <div id="hangouts-list"></div>
    </div>

    <div class="test-section">
        <h2>3. Hangout Detail Test</h2>
        <button onclick="testHangoutDetail()">Test Hangout Detail</button>
        <div id="hangout-detail-result" class="test-result"></div>
        <div id="hangout-detail"></div>
    </div>

    <div class="test-section">
        <h2>4. Voting Test</h2>
        <button onclick="testVoting()">Test Voting System</button>
        <div id="voting-result" class="test-result"></div>
        <div id="voting-section"></div>
    </div>

    <div class="test-section">
        <h2>5. Chat Test</h2>
        <button onclick="testChat()">Test Chat System</button>
        <div id="chat-result" class="test-result"></div>
        <div id="chat-section"></div>
    </div>

    <div class="test-section">
        <h2>6. Photo Upload Test</h2>
        <button onclick="testPhotoUpload()">Test Photo Upload</button>
        <div id="photo-result" class="test-result"></div>
        <div id="photo-section"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentUser = null;
        let currentHangout = null;
        let authToken = null;

        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `test-result ${type}`;
        }

        async function testAuth() {
            try {
                logResult('auth-result', 'Testing authentication...', 'info');
                
                // Test signup
                const signupResponse = await fetch(`${API_BASE}/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        username: 'testuser',
                        name: 'Test User',
                        password: 'password123'
                    })
                });

                if (signupResponse.ok) {
                    const signupData = await signupResponse.json();
                    authToken = signupData.data.token;
                    currentUser = signupData.data.user;
                    logResult('auth-result', '✅ Signup successful!', 'success');
                } else {
                    // Try login instead
                    const loginResponse = await fetch(`${API_BASE}/auth/signin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: 'test@example.com',
                            password: 'password123'
                        })
                    });

                    if (loginResponse.ok) {
                        const loginData = await loginResponse.json();
                        authToken = loginData.data.token;
                        currentUser = loginData.data.user;
                        logResult('auth-result', '✅ Login successful!', 'success');
                    } else {
                        throw new Error('Both signup and login failed');
                    }
                }
            } catch (error) {
                logResult('auth-result', `❌ Auth failed: ${error.message}`, 'error');
            }
        }

        async function testDiscover() {
            try {
                logResult('discover-result', 'Loading discover hangouts...', 'info');
                
                const response = await fetch(`${API_BASE}/discover`);
                const data = await response.json();
                
                if (data.success) {
                    logResult('discover-result', `✅ Found ${data.data.hangouts.length} hangouts`, 'success');
                    displayHangouts(data.data.hangouts);
                } else {
                    throw new Error(data.error || 'Failed to load hangouts');
                }
            } catch (error) {
                logResult('discover-result', `❌ Discover failed: ${error.message}`, 'error');
            }
        }

        function displayHangouts(hangouts) {
            const container = document.getElementById('hangouts-list');
            container.innerHTML = '';
            
            hangouts.forEach(hangout => {
                const card = document.createElement('div');
                card.className = 'hangout-card';
                card.innerHTML = `
                    <h3>${hangout.title}</h3>
                    <p>${hangout.description || 'No description'}</p>
                    ${hangout.image ? `<img src="${hangout.image}" class="hangout-image" alt="Hangout image">` : '<p>No image</p>'}
                    <p><strong>Creator:</strong> ${hangout.users.name} (@${hangout.users.username})</p>
                    <p><strong>Start:</strong> ${new Date(hangout.startTime).toLocaleString()}</p>
                    <p><strong>Privacy:</strong> ${hangout.privacyLevel}</p>
                    <div class="participant-list">
                        ${hangout.content_participants.map(p => 
                            `<span class="participant">${p.users.name} (${p.role})</span>`
                        ).join('')}
                    </div>
                    <button onclick="testHangoutDetail('${hangout.id}')">View Details</button>
                `;
                container.appendChild(card);
            });
        }

        async function testHangoutDetail(hangoutId = null) {
            try {
                if (!hangoutId) {
                    // Get first hangout from discover
                    const response = await fetch(`${API_BASE}/discover`);
                    const data = await response.json();
                    if (data.success && data.data.hangouts.length > 0) {
                        hangoutId = data.data.hangouts[0].id;
                    } else {
                        throw new Error('No hangouts available');
                    }
                }

                logResult('hangout-detail-result', `Loading hangout details for ${hangoutId}...`, 'info');
                
                const response = await fetch(`${API_BASE}/hangouts/${hangoutId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentHangout = data.data;
                    logResult('hangout-detail-result', '✅ Hangout details loaded successfully', 'success');
                    displayHangoutDetail(data.data);
                } else {
                    throw new Error(data.error || 'Failed to load hangout details');
                }
            } catch (error) {
                logResult('hangout-detail-result', `❌ Hangout detail failed: ${error.message}`, 'error');
            }
        }

        function displayHangoutDetail(hangout) {
            const container = document.getElementById('hangout-detail');
            container.innerHTML = `
                <div class="hangout-card">
                    <h3>${hangout.title}</h3>
                    <p>${hangout.description || 'No description'}</p>
                    ${hangout.image ? `<img src="${hangout.image}" class="hangout-image" alt="Hangout image">` : '<p>No image</p>'}
                    <p><strong>Creator:</strong> ${hangout.users.name} (@${hangout.users.username})</p>
                    <p><strong>Start:</strong> ${new Date(hangout.startTime).toLocaleString()}</p>
                    <p><strong>End:</strong> ${new Date(hangout.endTime).toLocaleString()}</p>
                    <p><strong>Privacy:</strong> ${hangout.privacyLevel}</p>
                    <p><strong>Participants:</strong> ${hangout.content_participants.length}</p>
                </div>
            `;
        }

        async function testVoting() {
            if (!currentHangout) {
                logResult('voting-result', '❌ No hangout selected. Please load hangout details first.', 'error');
                return;
            }

            try {
                logResult('voting-result', 'Testing voting system...', 'info');
                
                // Get polls for this hangout
                const response = await fetch(`${API_BASE}/hangouts/${currentHangout.id}/polls`);
                const data = await response.json();
                
                if (data.success && data.data.polls.length > 0) {
                    const poll = data.data.polls[0];
                    logResult('voting-result', `✅ Found poll: ${poll.title}`, 'success');
                    displayVotingSection(poll);
                } else {
                    logResult('voting-result', 'No polls found for this hangout', 'info');
                }
            } catch (error) {
                logResult('voting-result', `❌ Voting test failed: ${error.message}`, 'error');
            }
        }

        function displayVotingSection(poll) {
            const container = document.getElementById('voting-section');
            container.innerHTML = `
                <div class="vote-section">
                    <h4>${poll.title}</h4>
                    <p>${poll.description || 'No description'}</p>
                    <p><strong>Status:</strong> ${poll.status}</p>
                    <p><strong>Consensus:</strong> ${poll.consensusPercentage}%</p>
                    <div id="poll-options">
                        ${JSON.parse(poll.options).map((option, index) => `
                            <div class="vote-option">
                                <span>${option}</span>
                                <button class="vote-button" onclick="voteForOption('${poll.id}', '${option}')">
                                    Vote
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function voteForOption(pollId, option) {
            if (!authToken) {
                alert('Please authenticate first');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/hangouts/${currentHangout.id}/vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        optionId: option,
                        action: 'toggle'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    logResult('voting-result', `✅ Vote successful: ${data.message}`, 'success');
                    // Update UI to show voted state
                    const button = event.target;
                    button.textContent = 'Voted ✓';
                    button.classList.add('voted');
                } else {
                    const errorData = await response.json();
                    logResult('voting-result', `❌ Vote failed: ${errorData.error}`, 'error');
                }
            } catch (error) {
                logResult('voting-result', `❌ Vote error: ${error.message}`, 'error');
            }
        }

        async function testChat() {
            if (!currentHangout) {
                logResult('chat-result', '❌ No hangout selected. Please load hangout details first.', 'error');
                return;
            }

            try {
                logResult('chat-result', 'Testing chat system...', 'info');
                
                // Send a test message
                const response = await fetch(`${API_BASE}/hangouts/${currentHangout.id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        text: 'Test message from automated test'
                    })
                });

                if (response.ok) {
                    logResult('chat-result', '✅ Message sent successfully', 'success');
                    loadMessages();
                } else {
                    const errorData = await response.json();
                    logResult('chat-result', `❌ Chat failed: ${errorData.error}`, 'error');
                }
            } catch (error) {
                logResult('chat-result', `❌ Chat error: ${error.message}`, 'error');
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch(`${API_BASE}/hangouts/${currentHangout.id}/messages`);
                const data = await response.json();
                
                if (data.success) {
                    displayMessages(data.data.messages);
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('chat-section');
            container.innerHTML = `
                <div class="chat-section">
                    <h4>Chat Messages</h4>
                    <div id="messages-list">
                        ${messages.map(msg => `
                            <div class="message">
                                <strong>${msg.senderName}:</strong> ${msg.text}
                                <br><small>${new Date(msg.createdAt).toLocaleString()}</small>
                            </div>
                        `).join('')}
                    </div>
                    <input type="text" class="message-input" placeholder="Type a message..." id="message-input">
                    <button onclick="sendMessage()">Send</button>
                </div>
            `;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) return;

            try {
                const response = await fetch(`${API_BASE}/hangouts/${currentHangout.id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ text })
                });

                if (response.ok) {
                    input.value = '';
                    loadMessages();
                } else {
                    const errorData = await response.json();
                    logResult('chat-result', `❌ Send failed: ${errorData.error}`, 'error');
                }
            } catch (error) {
                logResult('chat-result', `❌ Send error: ${error.message}`, 'error');
            }
        }

        async function testPhotoUpload() {
            if (!currentHangout) {
                logResult('photo-result', '❌ No hangout selected. Please load hangout details first.', 'error');
                return;
            }

            try {
                logResult('photo-result', 'Testing photo upload...', 'info');
                
                // Create a test image
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#792ADB';
                ctx.fillRect(0, 0, 400, 300);
                ctx.fillStyle = 'white';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Test Photo', 200, 150);
                ctx.fillText(new Date().toLocaleString(), 200, 180);
                
                const dataUrl = canvas.toDataURL('image/png');
                
                const response = await fetch(`${API_BASE}/hangouts/${currentHangout.id}/photos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        imageData: dataUrl,
                        caption: 'Test photo from automated test'
                    })
                });

                if (response.ok) {
                    logResult('photo-result', '✅ Photo uploaded successfully', 'success');
                    loadPhotos();
                } else {
                    const errorData = await response.json();
                    logResult('photo-result', `❌ Photo upload failed: ${errorData.error}`, 'error');
                }
            } catch (error) {
                logResult('photo-result', `❌ Photo upload error: ${error.message}`, 'error');
            }
        }

        async function loadPhotos() {
            try {
                const response = await fetch(`${API_BASE}/hangouts/${currentHangout.id}/photos`);
                const data = await response.json();
                
                if (data.success) {
                    displayPhotos(data.data.photos);
                }
            } catch (error) {
                console.error('Failed to load photos:', error);
            }
        }

        function displayPhotos(photos) {
            const container = document.getElementById('photo-section');
            container.innerHTML = `
                <div class="photo-section">
                    <h4>Photos</h4>
                    <div class="photo-grid">
                        ${photos.map(photo => `
                            <img src="${photo.originalUrl}" class="photo-item" alt="Hangout photo">
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Auto-run tests on page load
        window.onload = function() {
            setTimeout(() => {
                testAuth();
            }, 1000);
        };
    </script>
</body>
</html>

















