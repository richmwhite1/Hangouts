<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Frontend Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        .test-section {
            border: 1px solid #333;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            background-color: #2a2a2a;
        }
        .error {
            color: #ef4444;
            background-color: #2d1b1b;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #4ade80;
            background-color: #1b2d1b;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #fbbf24;
            background-color: #2d2a1b;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .poll {
            border: 1px solid #444;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            background-color: #333;
        }
        .option {
            border: 2px solid #444;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #444;
        }
        .option:hover {
            border-color: #666;
            background-color: #555;
        }
        .option.voted {
            border-color: #4ade80;
            background-color: rgba(74, 222, 128, 0.1);
        }
        .vote-bar {
            background-color: #4ade80;
            height: 4px;
            margin-top: 10px;
            border-radius: 2px;
            transition: width 0.3s;
        }
        button {
            background-color: #4ade80;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #22c55e;
        }
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        pre {
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Complete Frontend Polling Test</h1>
    
    <div class="test-section">
        <h2>1. Authentication Test</h2>
        <div id="auth-status" class="info">Checking authentication...</div>
        <button onclick="testAuth()">Test Authentication</button>
    </div>

    <div class="test-section">
        <h2>2. Hangout Creation Test</h2>
        <div id="hangout-status" class="info">Ready to create hangout...</div>
        <button onclick="createTestHangout()">Create Test Hangout</button>
        <div id="hangout-result"></div>
    </div>

    <div class="test-section">
        <h2>3. Poll Creation Test</h2>
        <div id="poll-status" class="info">Ready to create poll...</div>
        <button onclick="createTestPoll()">Create Test Poll</button>
        <div id="poll-result"></div>
    </div>

    <div class="test-section">
        <h2>4. Poll Display Test</h2>
        <div id="polls-status" class="info">Ready to fetch polls...</div>
        <button onclick="fetchPolls()">Fetch Polls</button>
        <div id="polls-result"></div>
    </div>

    <div class="test-section">
        <h2>5. Voting Test</h2>
        <div id="vote-status" class="info">Ready to test voting...</div>
        <button onclick="testVoting()">Test Voting</button>
        <div id="vote-result"></div>
    </div>

    <div class="test-section">
        <h2>6. Complete Flow Test</h2>
        <div id="flow-status" class="info">Ready to run complete flow...</div>
        <button onclick="runCompleteFlow()">Run Complete Flow</button>
        <div id="flow-result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let currentHangoutId = null;
        let currentPollId = null;
        let authToken = null;

        // Test authentication
        async function testAuth() {
            const statusEl = document.getElementById('auth-status');
            try {
                // Try to get token from localStorage
                const storedToken = localStorage.getItem('auth_token');
                if (storedToken) {
                    authToken = storedToken;
                    statusEl.innerHTML = '<div class="success">‚úÖ Token found in localStorage</div>';
                    return;
                }

                // Create a test token
                const response = await fetch(`${API_BASE}/api/auth/test-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'cmfq75h2v0000jpf08u3kfi6b',
                        email: 'bill@email.com',
                        username: 'bill'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    localStorage.setItem('auth_token', authToken);
                    statusEl.innerHTML = '<div class="success">‚úÖ Test token created</div>';
                } else {
                    statusEl.innerHTML = '<div class="error">‚ùå Failed to create test token</div>';
                }
            } catch (error) {
                statusEl.innerHTML = `<div class="error">‚ùå Auth test failed: ${error.message}</div>`;
            }
        }

        // Create test hangout
        async function createTestHangout() {
            const statusEl = document.getElementById('hangout-status');
            const resultEl = document.getElementById('hangout-result');
            
            if (!authToken) {
                statusEl.innerHTML = '<div class="error">‚ùå No auth token available</div>';
                return;
            }

            try {
                statusEl.innerHTML = '<div class="info">üîÑ Creating hangout...</div>';
                
                const hangoutData = {
                    title: "Frontend Test Hangout",
                    description: "Testing poll creation from frontend",
                    location: "Test Location",
                    startDate: new Date().toISOString().split('T')[0],
                    startTime: "19:00",
                    endDate: new Date().toISOString().split('T')[0],
                    endTime: "22:00",
                    type: "HANGOUT",
                    privacyLevel: "FRIENDS",
                    selectedFriends: []
                };

                const response = await fetch(`${API_BASE}/api/hangouts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(hangoutData)
                });

                if (response.ok) {
                    const data = await response.json();
                    currentHangoutId = data.hangout.id;
                    statusEl.innerHTML = '<div class="success">‚úÖ Hangout created successfully</div>';
                    resultEl.innerHTML = `<pre>Hangout ID: ${currentHangoutId}</pre>`;
                } else {
                    const errorText = await response.text();
                    statusEl.innerHTML = '<div class="error">‚ùå Failed to create hangout</div>';
                    resultEl.innerHTML = `<pre>Error: ${errorText}</pre>`;
                }
            } catch (error) {
                statusEl.innerHTML = '<div class="error">‚ùå Hangout creation failed</div>';
                resultEl.innerHTML = `<pre>Error: ${error.message}</pre>`;
            }
        }

        // Create test poll
        async function createTestPoll() {
            const statusEl = document.getElementById('poll-status');
            const resultEl = document.getElementById('poll-result');
            
            if (!authToken || !currentHangoutId) {
                statusEl.innerHTML = '<div class="error">‚ùå No auth token or hangout ID available</div>';
                return;
            }

            try {
                statusEl.innerHTML = '<div class="info">üîÑ Creating poll...</div>';
                
                const pollData = {
                    title: "Frontend Test Poll",
                    description: "Testing poll creation from frontend",
                    options: [
                        {
                            text: "Option A",
                            description: "First option",
                            date: "2025-09-23",
                            time: "7:00 PM",
                            location: "Location A",
                            latitude: null,
                            longitude: null
                        },
                        {
                            text: "Option B",
                            description: "Second option", 
                            date: "2025-09-23",
                            time: "8:00 PM",
                            location: "Location B",
                            latitude: null,
                            longitude: null
                        }
                    ],
                    consensusConfig: {
                        consensusType: "PERCENTAGE",
                        threshold: 60,
                        minParticipants: 2,
                        allowTies: false,
                        customRules: {}
                    },
                    allowMultiple: true,
                    isAnonymous: false,
                    allowDelegation: false,
                    allowAbstention: true,
                    isPublic: false,
                    visibility: "FRIENDS",
                    allowAddOptions: true
                };

                const response = await fetch(`${API_BASE}/api/hangouts/${currentHangoutId}/polls`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(pollData)
                });

                if (response.ok) {
                    const data = await response.json();
                    currentPollId = data.poll.id;
                    statusEl.innerHTML = '<div class="success">‚úÖ Poll created successfully</div>';
                    resultEl.innerHTML = `<pre>Poll ID: ${currentPollId}\n${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    const errorText = await response.text();
                    statusEl.innerHTML = '<div class="error">‚ùå Failed to create poll</div>';
                    resultEl.innerHTML = `<pre>Error: ${errorText}</pre>`;
                }
            } catch (error) {
                statusEl.innerHTML = '<div class="error">‚ùå Poll creation failed</div>';
                resultEl.innerHTML = `<pre>Error: ${error.message}</pre>`;
            }
        }

        // Fetch polls
        async function fetchPolls() {
            const statusEl = document.getElementById('polls-status');
            const resultEl = document.getElementById('polls-result');
            
            if (!authToken || !currentHangoutId) {
                statusEl.innerHTML = '<div class="error">‚ùå No auth token or hangout ID available</div>';
                return;
            }

            try {
                statusEl.innerHTML = '<div class="info">üîÑ Fetching polls...</div>';
                
                const response = await fetch(`${API_BASE}/api/hangouts/${currentHangoutId}/polls-simple`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    statusEl.innerHTML = `<div class="success">‚úÖ Found ${data.polls?.length || 0} polls</div>`;
                    
                    if (data.polls && data.polls.length > 0) {
                        resultEl.innerHTML = data.polls.map(poll => `
                            <div class="poll">
                                <h3>${poll.title}</h3>
                                <p>${poll.description || ''}</p>
                                <div><strong>Total Votes:</strong> ${poll.totalVotes}</div>
                                <div><strong>Options:</strong> ${poll.pollOptions?.length || 0}</div>
                                <div><strong>Status:</strong> ${poll.status}</div>
                                <div><strong>Visibility:</strong> ${poll.visibility}</div>
                                ${poll.pollOptions ? poll.pollOptions.map(option => `
                                    <div class="option">
                                        <div><strong>${option.text}</strong></div>
                                        <div>Votes: ${option.voteCount} (${option.percentage?.toFixed(1)}%)</div>
                                        <div class="vote-bar" style="width: ${option.percentage || 0}%"></div>
                                    </div>
                                `).join('') : ''}
                            </div>
                        `).join('');
                    } else {
                        resultEl.innerHTML = '<div class="info">No polls found</div>';
                    }
                } else {
                    const errorText = await response.text();
                    statusEl.innerHTML = '<div class="error">‚ùå Failed to fetch polls</div>';
                    resultEl.innerHTML = `<pre>Error: ${errorText}</pre>`;
                }
            } catch (error) {
                statusEl.innerHTML = '<div class="error">‚ùå Poll fetch failed</div>';
                resultEl.innerHTML = `<pre>Error: ${error.message}</pre>`;
            }
        }

        // Test voting
        async function testVoting() {
            const statusEl = document.getElementById('vote-status');
            const resultEl = document.getElementById('vote-result');
            
            if (!authToken || !currentPollId) {
                statusEl.innerHTML = '<div class="error">‚ùå No auth token or poll ID available</div>';
                return;
            }

            try {
                statusEl.innerHTML = '<div class="info">üîÑ Testing vote...</div>';
                
                // First get poll options
                const pollResponse = await fetch(`${API_BASE}/api/hangouts/${currentHangoutId}/polls-simple`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!pollResponse.ok) {
                    throw new Error('Failed to fetch poll options');
                }

                const pollData = await pollResponse.json();
                const poll = pollData.polls.find(p => p.id === currentPollId);
                
                if (!poll || !poll.pollOptions || poll.pollOptions.length === 0) {
                    throw new Error('No poll options found');
                }

                const optionId = poll.pollOptions[0].id;
                
                const voteData = {
                    optionId: optionId,
                    voteType: 'SINGLE',
                    weight: 1.0
                };

                const response = await fetch(`${API_BASE}/api/polls/${currentPollId}/vote-simple`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(voteData)
                });

                if (response.ok) {
                    const data = await response.json();
                    statusEl.innerHTML = '<div class="success">‚úÖ Vote cast successfully</div>';
                    resultEl.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    const errorText = await response.text();
                    statusEl.innerHTML = '<div class="error">‚ùå Failed to cast vote</div>';
                    resultEl.innerHTML = `<pre>Error: ${errorText}</pre>`;
                }
            } catch (error) {
                statusEl.innerHTML = '<div class="error">‚ùå Vote test failed</div>';
                resultEl.innerHTML = `<pre>Error: ${error.message}</pre>`;
            }
        }

        // Run complete flow
        async function runCompleteFlow() {
            const statusEl = document.getElementById('flow-status');
            const resultEl = document.getElementById('flow-result');
            
            try {
                statusEl.innerHTML = '<div class="info">üîÑ Running complete flow...</div>';
                resultEl.innerHTML = '';
                
                // Step 1: Test auth
                await testAuth();
                if (!authToken) {
                    throw new Error('Authentication failed');
                }
                
                // Step 2: Create hangout
                await createTestHangout();
                if (!currentHangoutId) {
                    throw new Error('Hangout creation failed');
                }
                
                // Step 3: Create poll
                await createTestPoll();
                if (!currentPollId) {
                    throw new Error('Poll creation failed');
                }
                
                // Step 4: Fetch polls
                await fetchPolls();
                
                // Step 5: Test voting
                await testVoting();
                
                statusEl.innerHTML = '<div class="success">‚úÖ Complete flow successful!</div>';
                resultEl.innerHTML = '<div class="success">All tests passed successfully!</div>';
                
            } catch (error) {
                statusEl.innerHTML = '<div class="error">‚ùå Complete flow failed</div>';
                resultEl.innerHTML = `<pre>Error: ${error.message}</pre>`;
            }
        }

        // Initialize
        window.onload = function() {
            testAuth();
        };
    </script>
</body>
</html>




























