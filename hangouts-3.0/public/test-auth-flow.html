<!DOCTYPE html>
<html>
<head>
    <title>Test Auth Flow</title>
</head>
<body>
    <h1>Test Authentication Flow</h1>
    <div id="status"></div>
    <button onclick="testSignIn()">Test Sign In</button>
    <button onclick="testAuthMe()">Test Auth Me</button>
    <button onclick="testConversations()">Test Conversations</button>
    <button onclick="clearAuth()">Clear Auth</button>
    
    <script>
        const API_BASE = 'http://localhost:3000';
        let currentToken = null;
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
        }
        
        async function testSignIn() {
            try {
                updateStatus('Testing sign in...');
                const response = await fetch(`${API_BASE}/api/auth/signin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'alice@example.com',
                        password: 'Password1!'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    currentToken = data.data.token;
                    localStorage.setItem('auth_token', currentToken);
                    localStorage.setItem('auth_user', JSON.stringify(data.data.user));
                    updateStatus('Sign in successful! Token: ' + currentToken.substring(0, 20) + '...');
                } else {
                    updateStatus('Sign in failed: ' + data.error);
                }
            } catch (error) {
                updateStatus('Sign in error: ' + error.message);
            }
        }
        
        async function testAuthMe() {
            try {
                updateStatus('Testing auth/me...');
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    updateStatus('No token found in localStorage');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    updateStatus('Auth/me successful! User: ' + data.data.user.name);
                } else {
                    updateStatus('Auth/me failed: ' + data.error);
                }
            } catch (error) {
                updateStatus('Auth/me error: ' + error.message);
            }
        }
        
        async function testConversations() {
            try {
                updateStatus('Testing conversations...');
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    updateStatus('No token found in localStorage');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/api/conversations`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    updateStatus('Conversations successful! Found ' + data.data.conversations.length + ' conversations');
                } else {
                    updateStatus('Conversations failed: ' + data.error);
                }
            } catch (error) {
                updateStatus('Conversations error: ' + error.message);
            }
        }
        
        function clearAuth() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('auth_user');
            currentToken = null;
            updateStatus('Auth cleared');
        }
        
        // Check initial state
        window.onload = function() {
            const token = localStorage.getItem('auth_token');
            const user = localStorage.getItem('auth_user');
            updateStatus('Page loaded. Token: ' + (token ? 'Found' : 'Not found') + ', User: ' + (user ? 'Found' : 'Not found'));
        }
    </script>
</body>
</html>
